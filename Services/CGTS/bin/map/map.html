<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Map data</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
    <link rel="stylesheet" href="theme/default/style.css" type="text/css" />
    <link rel="stylesheet" href="style.css" type="text/css" />
	<style type="text/css">
	<!--
	html, body {
	  margin:0;
	  padding:0;
	  width:100%;
	  height:100%;
	}
	#map {
	  position: relative;
	  min-height: 100%;
	  /*background-color:#FF0000;*/
	}
	* html #map {
	  height: 100%;
	}
	#footer {
	  position: relative;
	  margin-top: -2.5em;
	  height: 2.5em;
	}
	.olControlLayerSwitcher .layersDiv {
       padding-top: 5px;
       padding-left: 10px;
       padding-bottom: 5px;
       padding-right: 65px;
       background-color: #eae5d8;
       width: 100%;
       height: 100%;
	   color:black;
	}
	.olControlOverviewMapElement {
	    padding: 10px 18px 10px 10px;
	    background-color: #eae5d8; /*#00008B; */
    	-moz-border-radius: 1em 0 0 0;
		border-style:solid;
		border-width:1px;
		border-color:#898477;	
	}
	-->
	</style>
	
    <script type="text/javascript" src="OpenLayers.js"></script>
    <script type="text/javascript" src="Custom.js"></script>
	<script type="text/javascript">
        
			var m_map;
			var firstLat = 57;
			var firstLon = 84;
			var firstZoom = 4;
			var firstLayerName = "";
			var geozones_control;
			var mapLoaded = false;
			var disable_double_click = false;
			var disable_double_click_control = null;
			var LayersWithBackingLayers = [];
			var routes_list = null;
			var routes_list_pos = null;
			var play_route_sec = null;
			var play_route_max = 0;
			var play_route_k = 1000;
			var play_route_intervalid = null;
			var play_route_start_date = null;
			var play_route_pause = false;
			// $VARIABLES
			
            function webgis_map_options(opts) {
				if (typeof opts != 'object') opts = new Object;
				opts.maxExtent = new OpenLayers.Bounds( - 20037508.3427892, -20037508.3427892, 20037508.3427892, 20037508.3427892);
				opts.numZoomLevels = 19;
				opts.maxResolution = 156543.0339;
				opts.units = 'm';
				opts.projection = "EPSG:900913";
				opts.displayProjection = new OpenLayers.Projection("EPSG:4326");
				return opts;
			}
			
			function init(){
                
				var map_options = webgis_map_options({
					controls: [],
					theme: null,
					eventListeners: {                     
                        "changebaselayer": mapBaseLayerChanged
                    }
				});
				m_map = new OpenLayers.Map('map', map_options);
				
				var layers = new Array;				
				
				// $MAPS
try {
	
layers.push(new OpenLayers.Layer.MapEPSG_900913('OSM (Mapnik)',
	'http://tile.openstreetmap.org/',
	{ 
		attribution: '<a href="http://www.openstreetmap.org/">OpenStreetMap</a>'
		,getTileAddress: function(bounds,x,y,z) {
   var subs = [ 'a', 'b', 'c' ];   
   return "http://" + subs[(x+y)%3] + ".tile.openstreetmap.org/" + z + "/" + x + "/" + y + ".png";
},
getTileAddress2: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=osm_mapnik&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	

//////

layers.push(new OpenLayers.Layer.MapEPSG_900913('CityGUIDE',
	'http://ingit.ru/',
	{ 
		attribution: '<a href="http://www.ingit.ru/">INGIT</a>'
		,getTileAddressCustom: function(bounds,x,y,z) {
   return "http://127.0.0.1:2030/render/" + z + "/" + x + "/" + y + ".png";
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:2030/render/" + z + "/" + x + "/" + y + ".png";
}					
	})				
);	

/////

layers.push(new OpenLayers.Layer.MapEPSG_900913('OSM (Osmarender)',
	'http://tah.openstreetmap.org/Tiles/tile/',
	{ 
		attribution: '<a href="http://www.openstreetmap.org/">OpenStreetMap</a>'
		,getTileAddressCustom: function(bounds,x,y,z) {
   var subs = [ 'a', 'b', 'c' ];   
   return "http://" + subs[(x+y)%3] + ".tah.openstreetmap.org/Tiles/tile/" + z + "/" + x + "/" + y + ".png";
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=osm_home&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('CloudMade',
	'http://b.tile.cloudmade.com/b340f66132415b1fb597971398c1bfc0/',
	{ 
		attribution: '<a href="http://cloudmade.com">CloudMade</a>'
		,getTileAddressCustom: function(bounds,x,y,z) {
   var subs = [ 'a', 'b', 'c' ];   
   return "http://" + subs[(x+y)%3] + ".tile.cloudmade.com/b340f66132415b1fb597971398c1bfc0/1/256/"
           + z + "/" + x + "/" + y + ".png";
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=cloudmade&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('Navitel',
	'http://maps.navitel.su/navitms.fcgi?t=',
	{ 
		attribution: '<a href="http://maps.navitel.su">Navitel</a>'
		,getTileAddressCustom: function(bounds,x,y,z) {
   xx = "" + x;
   yy = "" + Math.round(Math.pow(2,z)-y-1);
   zz = "" + z;                          
   while (xx.length < 8) { xx = "0" + xx; }
   while (yy.length < 8) { yy = "0" +yy; }
   while (zz.length < 2) { zz = "0" + zz; }
   return "http://maps.navitel.su/navitms.fcgi?t="+xx+","+yy+","+zz;
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=navitel&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('Google Схема',
	'http://maps.google.com',
	{ 
		attribution: '<a href="http://google.com">Google</a>'
		,maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
getTileAddressCustom: function(bounds,x,y,z) {
   var strGalileo = "Galileo";
   var subs = [ '0', '1' ];    
   return "http://mt" + subs[(x+y)%2] + ".google.com/vt/lyrs=m@137&hl=ru&x=" + x + "&y=" + y + "&z=" + z + "&s=" + strGalileo.substr(0, (3*x+y)%8 );
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=google_map&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('Google Ландшафт',
	'http://maps.google.com',
	{ 
		attribution: '<a href="http://google.com">Google</a>'
		,maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
getTileAddressCustom: function(bounds,x,y,z) {
   var strGalileo = "Galileo";
   var subs = [ '0', '1' ];    
   return "http://mt" + subs[(x+y)%2] + ".google.com/vt/lyrs=t@126,r@137&hl=ru&x=" + x + "&y=" + y + "&z=" + z + "&s=" + strGalileo.substr(0, (3*x+y)%8 );
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=google_land&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('Google Спутник',
	'http://maps.google.com',
	{ 
		attribution: '<a href="http://google.com">Google</a>'
		,maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
getTileAddressCustom: function(bounds,x,y,z) {
   var strGalileo = "Galileo";
   var subs = [ '0', '1' ];    
   return "http://khm" + subs[(x+y)%2] + ".google.ru/kh/v=74&x=" + x + "&y=" + y + "&z=" + z + "&s=" + strGalileo.substr(0, (3*x+y)%8 );
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=google_sat&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
var Layer1 = new OpenLayers.Layer.MapEPSG_900913('Layer1',
	'http://maps.google.com',
	{ 
		attribution: '<a href="http://google.com">Google</a>'
		,isBaseLayer:false, visibility:false, displayInLayerSwitcher:false
		,maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
getTileAddressCustom: function(bounds,x,y,z) {
   var strGalileo = "Galileo";
   var subs = [ '0', '1' ];    
   return "http://mt" + subs[(x+y)%2] + ".google.com/vt/lyrs=h@137&hl=ru&x=" + x + "&y=" + y + "&z=" + z + "&s=" + strGalileo.substr(0, (3*x+y)%8 );
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=google_hyb&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	});
layers.push(Layer1);
				
var BaseLayer1 = new OpenLayers.Layer.MapEPSG_900913('Google Гибрид',
	'http://maps.google.com',
	{ 
		attribution: '<a href="http://google.com">Google</a>',
		top_layer: Layer1
		,maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
getTileAddressCustom: function(bounds,x,y,z) {
   var strGalileo = "Galileo";
   var subs = [ '0', '1' ];    
   return "http://khm" + subs[(x+y)%2] + ".google.ru/kh/v=74&x=" + x + "&y=" + y + "&z=" + z + "&s=" + strGalileo.substr(0, (3*x+y)%8 );
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=google_sat&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	});				

LayersWithBackingLayers.push(BaseLayer1);
layers.push(BaseLayer1);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('Visicom',
	'http://tms.visicom.ua/1.0.3/world_ru/',
	{ 
		attribution: '<a href="http://maps.visicom.ua">Visicom</a>'
		,maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
getTileAddressCustom: function(bounds,x,y,z) {
   var subs = [ '0', '1', '2' ];
   return "http://tms" + subs[(x+y)%3] + ".visicom.ua/1.0.3/world_ru/" + (z) + "/" + x + "/" + ((1 << (z)) - (y+1)) + ".png";
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=visicom&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('VE Схема',
	'http://a.ortho.tiles.virtualearth.net/tiles/',
	{ 
		attribution: '<a href="http://virtualearth.net">Microsoft</a>'
		,getTileAddressCustom: function(bounds,x,y,z) {
   var sTile = '000000'; 
   sTile += (parseInt(y.toString(2) * 2) + parseInt(x.toString(2)));
   sTile = sTile.substring(sTile.length - z, sTile.length); 
   return 'http://r' + sTile.substring(sTile.length-1, sTile.length) + '.ortho.tiles.virtualearth.net/tiles/r' + sTile + '.jpeg?g=1';
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=ve_map&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
layers.push(new OpenLayers.Layer.MapEPSG_900913('VE Спутник',
	'http://a.ortho.tiles.virtualearth.net/tiles/',
	{ 
		attribution: '<a href="http://virtualearth.net">Microsoft</a>'
		,getTileAddressCustom: function(bounds,x,y,z) {
   var sTile = '000000'; 
   sTile += (parseInt(y.toString(2) * 2) + parseInt(x.toString(2)));
   sTile = sTile.substring(sTile.length - z, sTile.length); 
   return 'http://a' + sTile.substring(sTile.length-1, sTile.length) + '.ortho.tiles.virtualearth.net/tiles/a' + sTile + '.jpeg?g=1';
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=ve_sat&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	})				
);	
var Layer2 = new OpenLayers.Layer.MapEPSG_900913('Layer2',
	'http://a.ortho.tiles.virtualearth.net/tiles/',
	{ 
		attribution: '<a href="http://virtualearth.net">Microsoft</a>'
		,isBaseLayer:false, visibility:false, displayInLayerSwitcher:false
		,getTileAddressCustom: function(bounds,x,y,z) {
   var sTile = '000000'; 
   sTile += (parseInt(y.toString(2) * 2) + parseInt(x.toString(2)));
   sTile = sTile.substring(sTile.length - z, sTile.length); 
   return 'http://h' + sTile.substring(sTile.length-1, sTile.length) + '.ortho.tiles.virtualearth.net/tiles/h' + sTile + '.jpeg?g=1';
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=ve_hyb&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	});
layers.push(Layer2);
				
var BaseLayer2 = new OpenLayers.Layer.MapEPSG_900913('VE Гибрид',
	'http://a.ortho.tiles.virtualearth.net/tiles/',
	{ 
		attribution: '<a href="http://virtualearth.net">Microsoft</a>',
		top_layer: Layer2
		,getTileAddressCustom: function(bounds,x,y,z) {
   var sTile = '000000'; 
   sTile += (parseInt(y.toString(2) * 2) + parseInt(x.toString(2)));
   sTile = sTile.substring(sTile.length - z, sTile.length); 
   return 'http://a' + sTile.substring(sTile.length-1, sTile.length) + '.ortho.tiles.virtualearth.net/tiles/a' + sTile + '.jpeg?g=1';
},
getTileAddress: function(bounds,x,y,z) {
    return "http://127.0.0.1:8089/?itob_host=" + this.getTileAddressCustom(bounds,x,y,z).replace(new RegExp("&",'g'),"%26") + "&itob_map_id=ve_sat&itob_x=" + x + "&itob_y=" + y + "&itob_z=" + z; 
}					
	});				

LayersWithBackingLayers.push(BaseLayer2);
layers.push(BaseLayer2);
} catch(err) {}
								
				m_map.addLayers(layers);
																				
				m_map.addControl(new OpenLayers.Control.MousePosition());
				m_map.addControl(new OpenLayers.Control.ScaleLine());
				m_map.addControl(new OpenLayers.Control.Navigation());				
				m_map.addControl(new OpenLayers.Control.LayerSwitcher({roundedCorner: true, roundedCornerColor: "#eae5d8"}));
				
				
				var opt = webgis_map_options({
					controls: [],
					theme: null
				});	
				var overviewControl = new OpenLayers.Control.OverviewMap({
					mapOptions: opt
				});				
				m_map.addControl(overviewControl);
				
				// $ATTRIBUTES
firstZoom = 9;
firstLat = 55.741813;
firstLon = 37.607483;
firstLayerName = "OSM (Mapnik)";
				
				var pt = new OpenLayers.LonLat(firstLon, firstLat);
				pt.transform(m_map.displayProjection, m_map.getProjectionObject());
				m_map.setCenter(pt, firstZoom);
				
				if (firstLayerName != "") {
					var find_lays = m_map.getLayersByName(firstLayerName);
					if (find_lays.length > 0) {
						m_map.setBaseLayer(find_lays[0]);
					}
				}
				
				mapLoaded = true;
				
				disable_double_click_control = new OpenLayers.Control.DisableDoubleClickControl();
				m_map.addControl(disable_double_click_control);
				disable_double_click_control.deactivate();
				
				if (disable_double_click) {
					var CustomClick = new OpenLayers.Control.DisableDoubleClickControl();
					m_map.addControl(CustomClick);
					CustomClick.activate();
				}				

            }			
			
			function mapBaseLayerChanged(event) {				
				
				for (var i = 0, len = LayersWithBackingLayers.length; i < len; i++) {
					if (m_map.baseLayer == LayersWithBackingLayers[i]) {
						m_map.baseLayer.top_layer.setVisibility(true);
					} else if (LayersWithBackingLayers[i].top_layer.getVisibility()==true) {
						LayersWithBackingLayers[i].top_layer.setVisibility(false);
					}					
				}
			
            }			
			
			/* Geozone manage */
			
			function create_geozones_control() {
				var geozone_layer = new OpenLayers.Layer.Vector("Geozone creation", {displayInLayerSwitcher: false});
				m_map.addLayer(geozone_layer);
				
				var default_style = {
        			fillColor: "#197B30",
			        fillOpacity: 0.4,
			        hoverFillColor: "white",
			        hoverFillOpacity: 0.8,
			        strokeColor: "#004A80",
			        strokeOpacity: 0.5,
			        strokeWidth: 1,
			        strokeLinecap: "round",
			        hoverStrokeColor: "#FDC689",
			        hoverStrokeOpacity: 0.5,
			        hoverStrokeWidth: 0.2,
			        pointRadius: 4,
			        hoverPointRadius: 1,
			        hoverPointUnit: "%",
			        pointerEvents: "visiblePainted"
			    }
								
				var geozone_style = OpenLayers.Util.extend({}, default_style);				
	            
				var geozone_last_style = OpenLayers.Util.extend({}, default_style);				
	            geozone_last_style.fillColor = "#FF0000";
	            geozone_last_style.fillOpacity = 0.9;
	            geozone_last_style.hoverFillColor = "red";
	            geozone_last_style.pointRadius = 4;
	            geozone_last_style.strokeColor = "#FF0000";
	            geozone_last_style.strokeWidth = 1; 
				
				var polyOptions = {
                    handlerOptions: {
                        style: geozone_style,
                        lastStyle: geozone_last_style
                    }
                }; 				
            	geozones_control = new OpenLayers.Control.DrawFeature(geozone_layer,
                                            OpenLayers.Handler.PolygonEx,
                                            polyOptions);
				m_map.addControl(geozones_control);
				
				m_map.events.register('zoomend', this, function() {
            		if (geozone_layer && geozones_control) geozone_redraw();
        		});
				
				geozones_control.activate();
			}
			
			function destroy_geozones_control() {
				if (geozones_control) {
					geozones_control.deactivate();
					m_map.removeControl(geozones_control);
					geozones_control = null;
				}
				var find_lays = m_map.getLayersByName("Geozone creation");
				if (find_lays.length > 0) {
					m_map.removeLayer(find_lays[0]);
				}
			}
			
			function geozone_redraw() {
				if (geozones_control.handler) {
                	geozones_control.handler.drawFeature();
            	}
			}
			
			/* Play routes */
			function PlayRouteHandlier() {
				var CurPos;
				
				if (play_route_pause != true) {				
				
					play_route_sec = play_route_sec+play_route_k/10;
					
					var CurDate = new Date(play_route_start_date.getTime() + 1000*play_route_sec);
					var CurDateStr = ""+CurDate.getDate()+"."+(CurDate.getMonth()+1)+"."+CurDate.getFullYear()+" "+CurDate.getHours()+":"+CurDate.getMinutes();//+":"+CurDate.getSeconds();
					
					if (play_route_sec > play_route_max) {
						StopPlayRoute();
					}
					
					for (var i = 0, len = routes_list.length; i < len; i++) {
						CurPos = routes_list_pos[i][0];
						OldPos = CurPos;
						
						if (routes_list[i].length <= CurPos+1) {
							continue;
						}	
						
						while(CurPos < routes_list[i].length && routes_list[i][CurPos][1] < play_route_sec) {
							CurPos = CurPos+1;
						}
						
						if (CurPos > 0) {
							CurPos = CurPos-1;
						}	
						routes_list_pos[i][0] = CurPos;
						
						pointFeature = routes_list_pos[i][1];
						
						if (OldPos != CurPos) {
							pt = routes_list[i][CurPos][0];
							pointFeature.move(pt);
												
							if (routes_list.length == 1) {
								m_map.setCenter(pt, m_map.getZoom());
							}
							
						}
						
						pointFeature.style.label = CurDateStr;
						// update
						pointFeature.layer.drawFeature(pointFeature);
											
					}
				}
				
			}
			
			function StopPlayRoute() {
				clearInterval(play_route_intervalid);
				play_route_intervalid = null;
				play_route_pause = false;

			}			
			
		
  </script>
  </head>
  <body onload="init()">
    <div id="map"></div>
    <div id="footer">
      <form name="form" method="get" style="visibility:hidden; height:0px; background-color:#FF0000;">
        <input name="result" type="hidden" value="" />
      </form>
    </div>
  </body>
</html>
